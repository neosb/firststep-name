<script>
    document.addEventListener("DOMContentLoaded", function () {
        const helloText = document.querySelector(".hello-text");
        const languageText = document.querySelector(".language-text");

        fetch("/fetch_json")
            .then((response) => response.json())
            .then((data) => {
                function updateText() {
                    const randomIndex = Math.floor(Math.random() * data.length);
                    helloText.textContent = data[randomIndex].hello;
                    languageText.textContent = data[randomIndex].language;
                }
                updateText();
                setInterval(updateText, 6000);
            })
            .catch((error) => console.error("Error fetching the JSON:", error));

        const form = document.getElementById("username-form");
        form.addEventListener("submit", function (event) {
            event.preventDefault(); // Prevent page reload

            const username = document.getElementById("username").value.trim();
            if (!username) return;

            const resultsContainer = document.getElementById("results");
            const progressBar = document.getElementById("progress-bar");
            const progressText = document.getElementById("progress-text");

            resultsContainer.innerHTML = ""; // Clear previous results
            progressBar.style.width = "0%";
            progressText.textContent = "0%";

            const wsProtocol =
                window.location.protocol === "https:" ? "wss:" : "ws:";
            const ws = new WebSocket(
                `${wsProtocol}//${window.location.host}/ws/${username}`,
            );

            const results = {};

            ws.onopen = function () {
                console.log("Connected to WebSocket server");
            };

            ws.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.completed === true) {
                    progressBar.style.width = "100%";
                    progressText.textContent = "Completed";
                    return;
                }

                const percentage = Math.round(
                    (data.completed / data.total) * 100,
                );
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${data.completed}/${data.total} (${percentage}%)`;

                results[data.site] = data;
                updateResultsList();
            };

            ws.onerror = function (error) {
                console.error("WebSocket error:", error);
            };

            ws.onclose = function () {
                console.log("Disconnected from WebSocket server");
            };

            function updateResultsList() {
                resultsContainer.innerHTML = "";
                const sortedResults = Object.values(results).sort((a, b) =>
                    a.site.localeCompare(b.site),
                );

                sortedResults.forEach((result) => {
                    const resultItem = document.createElement("div");
                    resultItem.className = `result-item ${result.is_taken ? "taken" : "available"}`;

                    resultItem.innerHTML = `
                        <div class="result-header">
                            <img src="${result.logo_url}" onerror="this.src='default-logo.png'" class="site-logo">
                            <strong>${result.site}</strong>
                            <span class="status ${result.is_taken ? "taken" : "available"}">
                                ${result.status}
                            </span>
                        </div>
                        <div class="result-url">
                            <a href="${result.url}" target="_blank">${result.url}</a>
                        </div>
                        ${result.error ? `<div class="error">${result.error}</div>` : ""}
                    `;

                    resultsContainer.appendChild(resultItem);
                });
            }
        });
    });
</script>
